<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planificador de Auditor√≠as</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --vino: #9e1a18;
            --tinto-titulos: #8c1822;
            --rojo: #e62330;
            --bg: #f5f7f8;
            --card: rgb(237, 237, 237);
            --white: #ffffff;
            --muted: #555555;
            --success: #1f8a4c;
            --font-main: 'Gotham', 'Montserrat', sans-serif;
            --btn-modal-text: #393939;
            --btn-modal-border: #9c1b1b;
            /* Nuevos colores para botones */
            --btn-bg: #656562;
            --btn-border: #9c1b1b;
            --btn-text: #dddedb;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--bg);
            color: #102027;
        }

        /* --- CABECERA (BANNER PRINCIPAL) --- */
        .app-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 40px;
            background-image: url('https://proplayer20.neocities.org/unnamed.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            height: 140px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: right;
            margin-right: 20px;
        }

        .brand {
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 26px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .sub-brand {
            font-family: var(--font-main);
            font-weight: 500;
            font-size: 17px;
            opacity: 0.95;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        /* --- LAYOUT --- */
        .wrap {
            max-width: 1250px;
            margin: 22px auto;
            padding: 18px;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            margin-bottom: 18px;
            border: 1px solid #e0e0e0;
        }

        .grid {
            display: grid;
            grid-template-columns: 6fr 4fr;
            gap: 20px;
            margin-top: 18px;
        }

        .left { min-height: 520px; }

        .right {
            background: #fff;
            border-radius: 10px;
            padding: 14px;
            position: relative;
            height: 100%;
            min-height: 520px;
            border: 1px solid #eee;
        }

        /* --- TITULOS --- */
        .std-title {
            color: var(--tinto-titulos);
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 14px;
            margin-top: 12px;
            display: block;
        }

        .std-title::first-letter { text-transform: uppercase; }

        /* --- INPUTS --- */
        input, textarea, select {
            width: 100%;
            padding: 8px 10px;
            margin-top: 6px;
            border-radius: 8px;
            border: 1px solid #d8e0e4;
            font-size: 14px;
            background: #fff;
            font-family: sans-serif;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .two-col { display: flex; gap: 12px; }
        .two-col > div { flex: 1; }

        .three-col { display: flex; gap: 12px; }
        .three-col > div { flex: 1; }

        /* --- BOTONES UNIFICADOS --- */
        .btn, .btn.ghost, .btn.secondary, .btn.add-btn {
            display: inline-block;
            padding: 10px 16px;
            border-radius: 8px;
            background-color: var(--btn-bg) !important;
            border: 1px solid var(--btn-border) !important;
            color: var(--btn-text) !important;
            font-family: var(--font-main);
            font-size: 14px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 12px;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn:hover, .btn.ghost:hover, .btn.secondary:hover, .btn.add-btn:hover {
            background-color: #50504d !important;
            border-color: #e62330 !important;
            color: #fff !important;
        }

        /* --- OBJETIVOS --- */
        .objetivos-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 4px;
            margin-top: 6px;
        }

        @media (min-width: 900px) {
            .objetivos-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .objetivo-item {
            padding: 4px 8px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #edf1f2;
            font-size: 12px;
        }

        .objetivo-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin: 0;
        }

        .objetivo-item input { width: auto; margin: 0; }

        /* --- RESUMEN DEL PLAN --- */
        .preview-title {
            color: var(--tinto-titulos);
            font-family: var(--font-main);
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .preview-block {
            background: rgb(248, 248, 248);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #eef2f3;
            margin-bottom: 10px;
        }

        .preview-row {
            margin-bottom: 6px;
            font-size: 14px;
            color: #24323a;
        }

        .preview-row strong {
            color: var(--tinto-titulos);
            font-family: var(--font-main);
        }

        .preview-day {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--rojo);
        }

        .preview-criterios-title {
            color: var(--tinto-titulos);
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 5px;
            display: block;
        }

        .criterio-detail-list {
            margin: 5px 0 10px 15px;
            font-size: 12px;
            color: #555;
        }

        .criterio-detail-list div { margin-bottom: 3px; }

        /* --- PERSONAS TAGS --- */
        .persona-preview-item {
            display: inline-flex;
            align-items: center;
            background: #f0f4f8;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 2px;
            font-size: 12px;
            border: 1px solid #dceefb;
        }

        .persona-preview-remove, .criterio-remove {
            color: #e63946;
            cursor: pointer;
            margin-left: 6px;
            font-weight: bold;
        }

        .criterio-remove {
            font-size: 14px;
            margin-left: 8px;
        }

        .persona-preview-add {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #e8f5e9;
            color: #2e7d32;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
            border: 1px solid #c8e6c9;
        }

        /* --- CALENDARIO --- */
        .calendar-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #eef3f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 8px;
        }

        .calendar-day.has-audit {
            background: linear-gradient(135deg, #ffe5e5, #ffd4d4);
            border-color: var(--rojo);
            cursor: pointer;
        }

        .calendar-day .day-number {
            font-weight: 700;
            font-size: 16px;
            color: #333;
        }

        .calendar-day.has-audit .badge {
            position: absolute;
            right: 4px;
            top: 4px;
            background: var(--rojo);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .calendar-tooltip {
            display: none;
            position: absolute;
            left: 50%;
            top: 100%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: var(--vino);
            color: white;
            padding: 12px;
            border-radius: 8px;
            min-width: 250px;
            z-index: 100;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .calendar-day:hover .calendar-tooltip { display: block; }

        /* --- PANEL EDITAR --- */
        .panel-editar {
            position: fixed;
            right: -50%;
            top: 0;
            width: 50%;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            transition: right 0.4s;
            overflow-y: auto;
        }

        .panel-editar.active { right: 0; }

        .panel-editar-header {
            background-image: url('https://proplayer20.neocities.org/unnamed.webp');
            background-size: cover;
            background-position: right center;
            box-shadow: inset 0 0 0 1000px rgba(0, 0, 0, 0.4);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-main);
        }

        /* CAMBIO APLICADO: Margen izquierdo del 15% al t√≠tulo */
        .panel-editar-header h2 {
            margin: 0;
            font-family: var(--font-main);
            margin-left: 10%;
        }

        .panel-editar-body {
            padding: 20px;
            background: var(--bg);
        }

        .overlay-editar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        .overlay-editar.active { display: block; }

        .ids-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .id-btn {
            padding: 8px;
            background: #fff;
            border: 1px solid var(--vino);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 700;
            color: var(--vino);
            transition: .2s;
            font-size: 12px;
            font-family: var(--font-main);
        }

        .id-btn:hover { background: var(--vino); color: white; }

        /* --- MODALES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--rojo);
            padding-bottom: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .panel-editar-header .modal-close { color: #ffffff; }

        /* Botones verticales en modal */
        .modal-vertical-btn {
            display: block;
            width: 100%;
            margin-bottom: 8px;
            text-align: left;
            background-color: #ffffff !important;
            border: 1px solid var(--btn-modal-border) !important;
            color: var(--btn-modal-text) !important;
            font-family: var(--font-main);
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-vertical-btn:hover {
            background-color: #f9f9f9 !important;
            border-color: var(--vino) !important;
        }

        .checklist-item {
            padding: 8px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #eee;
            margin-bottom: 6px;
        }

        .checklist-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin: 0;
        }

        .checklist-item input { width: auto; margin: 0; }
        .persona-nombre { font-family: var(--font-main); color: #555555; font-weight: 700; }
        .hidden { display: none !important; }
        .small-muted { font-size: 12px; color: #7b8b91; }

        .risk-text {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            color: #856404;
            font-weight: 600;
            font-size: 13px;
        }

        .horario-block {
            background: #fff;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #e5e9ec;
            margin-bottom: 12px;
            position: relative;
        }

        .horario-block .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e63946;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .criterios-seleccionados {
            margin-top: 12px;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 8px;
            border: 1px solid #d0e7ff;
        }

        .persona-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 15px;
            margin: 4px;
            font-size: 13px;
        }

        .search-box { margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-content">
            <div class="brand">Planificador de auditor√≠as SIG</div>
            <div class="sub-brand">Sistema Integrado de Gesti√≥n</div>
        </div>
    </div>

    <div class="wrap">
        <div class="card" style="background:#fff">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div style="display:flex;gap:10px;align-items:center">
                    <button class="btn" onclick="mostrarVistaPlanear()">üìñ Planear Auditor√≠a</button>
                    <button class="btn" onclick="abrirPanelEditar()">‚úèÔ∏è Editar Auditor√≠a</button>
                    <button class="btn" onclick="mostrarVistaCalendario()">üìÖ Calendario</button>
                </div>
            </div>

            <div id="vistaPlanear" class="hidden">
                <div class="grid">
                    <div class="left">
                        <div class="card">
                            <label class="std-title">Nombre de la auditor√≠a</label>
                            <input type="text" id="nombreAuditoria" />
                            <label class="std-title">Objetivos</label>
                            <div id="objetivosContainer" class="objetivos-grid"></div>
                        </div>
                        <div class="card">
                            <label class="std-title">Alcance</label>
                            <textarea id="alcanceInput"></textarea>
                            <label class="std-title">Riesgos</label>
                            <div class="risk-text">Ver los riesgos en el documento "Programa de auditor√≠as"</div>
                        </div>
                        <div class="card">
                            <div class="two-col">
                                <div>
                                    <label class="std-title">Modalidad</label>
                                    <select id="modalidadSelect">
                                        <option value=""></option>
                                        <option>Presencial</option>
                                        <option>Virtual</option>
                                        <option>Mixta</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="std-title">Tipo de auditor√≠a</label>
                                    <select id="tipoSelect">
                                        <option value=""></option>
                                        <option>Interna</option>
                                        <option>Externa</option>
                                    </select>
                                </div>
                            </div>
                            <h3 class="std-title" style="margin-top:20px;border-bottom:1px solid #eee;padding-bottom:5px;">Horarios</h3>
                            <div id="horariosContainer"></div>
                            <button class="btn add-btn" onclick="agregarHorario()">+ Agregar horario</button>
                            <label class="std-title">Observaciones</label>
                            <textarea id="obsInput"></textarea>
                            <div style="margin-top:14px;display:flex;gap:10px">
                                <button class="btn" onclick="accionGuardarYCrear()">Guardar y crear</button>
                                <button class="btn secondary" onclick="limpiarFormulario()">Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <div class="right">
                        <div class="preview-title">Resumen del plan</div>
                        <div id="previewArea">
                            <div class="preview-block">
                                <div class="preview-row"><strong>ID:</strong> <span id="pv_id">‚Äî</span></div>
                                <div class="preview-row"><strong>Nombre:</strong> <span id="pv_nombre">‚Äî</span></div>
                            </div>
                            <div class="preview-block">
                                <div class="preview-row"><strong>Objetivos:</strong></div>
                                <div style="margin-left:10px;font-size:13px"><span id="pv_objetivos">‚Äî</span></div>
                            </div>
                            <div class="preview-block">
                                <div class="preview-row"><strong>Alcance:</strong> <span id="pv_alcance">‚Äî</span></div>
                            </div>
                            <div class="preview-block">
                                <div class="preview-row"><strong>Mod/Tipo:</strong> <span id="pv_modalidad">‚Äî</span> / <span id="pv_tipo">‚Äî</span></div>
                            </div>
                            <div class="preview-block" id="pv_horarios_block">
                                <span class="preview-criterios-title">Criterios seleccionados:</span>
                                <div id="pv_horarios">‚Äî</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vistaCalendario" class="hidden">
                <div style="margin:15px 0;display:flex;gap:10px;align-items:center">
                    <button class="btn" onclick="cambiarMes(-1)">‚óÄ</button>
                    <span id="mesActual" style="font-weight:700"></span>
                    <button class="btn" onclick="cambiarMes(1)">‚ñ∂</button>
                </div>
                <div class="calendar-container" id="calendarioGrid"></div>
            </div>
        </div>
        <div id="msgArea"></div>
    </div>

    <div id="modalCriterios" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0;color:var(--tinto-titulos);font-family:var(--font-main)"></h3>
                <button class="modal-close" onclick="cerrarModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
                <button class="btn ghost" onclick="cerrarModal()">Cancelar</button>
                <button class="btn" onclick="guardarCriterios()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modalPersonas" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalPersonasTitle" style="margin:0;color:var(--tinto-titulos);font-family:var(--font-main)"></h3>
                <button class="modal-close" onclick="cerrarModalPersonas()">√ó</button>
            </div>
            <div class="search-box">
                <input type="text" id="buscarPersona" placeholder="üîç Buscar..." oninput="filtrarPersonas()" />
            </div>
            <div class="modal-body" id="modalPersonasBody" style="max-height:400px;overflow-y:auto"></div>
            <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
                <button class="btn ghost" onclick="cerrarModalPersonas()">Cancelar</button>
                <button class="btn" onclick="guardarPersonasSeleccionadas()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="overlay-editar" id="overlayEditar" onclick="cerrarPanelEditar()"></div>
    <div class="panel-editar" id="panelEditar">
        <div class="panel-editar-header">
            <h2>‚úèÔ∏è Editar Auditor√≠a</h2>
            <button class="modal-close" onclick="cerrarPanelEditar()">√ó</button>
        </div>
        <div class="panel-editar-body">
            <div id="selectorIDs">
                <h3 style="color:var(--vino);font-family:var(--font-main)">Selecciona</h3>
                <div class="search-box">
                    <input type="text" id="buscarID" placeholder="üîç Buscar ID..." oninput="filtrarIDs()" />
                </div>
                <div id="idsGrid" class="ids-grid"></div>
            </div>
            <div id="formularioEdicion" class="hidden"></div>
        </div>
    </div>

    <script>
        let auditores = [], auditados = [], procesos = {}, normas = {}, registroCalendario = [];
        const objetivosList = [
            "Evaluar cumplimiento de necesidades y expectativas de las partes interesadas",
            "Verificar cambios en los requisitos de los procesos, productos o servicios",
            "Verificar el nivel de madurez de los Sistemas de Gesti√≥n",
            "Evaluar los riesgos y oportunidades identificados",
            "Validar requisitos del Sistema de Gesti√≥n",
            "Validar requisitos legales y reglamentarios",
            "Desarrollar evaluaci√≥n a proveedores externos",
            "Validar resultados de auditor√≠as previas"
        ];
        
        let planActivo = { nombre: "", objetivos: [], alcance: "", modalidad: "", tipo: "", horarios: [], observaciones: "" };
        let horarioIdCounter = 0;
        let horariosCriterios = {};
        let modalHorarioActual = null, modalTipoActual = null, modalProcesoSeleccionado = null, modalNormaSeleccionada = null;
        let modalPersonasTipo = null, personasSeleccionadas = [];
        let auditoriaEnEdicion = null, todosLosIDs = [];
        let fechaCalendario = new Date();

        (function() {
            google.script.run.withSuccessHandler(d => auditores = d || []).obtenerAuditores();
            google.script.run.withSuccessHandler(d => auditados = d || []).obtenerAuditados();
            google.script.run.withSuccessHandler(d => procesos = d || {}).obtenerProcesos();
            google.script.run.withSuccessHandler(d => normas = d || {}).obtenerNormas();
            google.script.run.withSuccessHandler(d => {
                registroCalendario = d || [];
                renderCalendario();
            }).obtenerAuditoriasCalendario();
            
            renderObjetivos();
            agregarHorario();
            
            ["nombreAuditoria", "alcanceInput", "modalidadSelect", "tipoSelect", "obsInput"].forEach(id => {
                document.getElementById(id).addEventListener("input", actualizarPreview);
            });
        })();

        function mostrarVistaPlanear() {
            document.getElementById("vistaPlanear").classList.remove("hidden");
            document.getElementById("vistaCalendario").classList.add("hidden");
        }

        function mostrarVistaCalendario() {
            document.getElementById("vistaPlanear").classList.add("hidden");
            document.getElementById("vistaCalendario").classList.remove("hidden");
            renderCalendario();
        }

        function renderObjetivos() {
            const c = document.getElementById("objetivosContainer");
            c.innerHTML = "";
            objetivosList.forEach(obj => {
                const div = document.createElement("div");
                div.className = "objetivo-item";
                div.innerHTML = `<label><input type="checkbox" value="${escapeHtml(obj)}"> ${escapeHtml(obj)}</label>`;
                c.appendChild(div);
            });
            c.querySelectorAll("input").forEach(el => el.addEventListener("change", actualizarPreview));
        }

        /* GESTION HORARIOS */
        function agregarHorario(dataPrevia = null, containerId = "horariosContainer") {
            const container = document.getElementById(containerId);
            const id = horarioIdCounter++;
            const div = document.createElement("div");
            div.className = "horario-block";
            div.dataset.id = id;

            div.innerHTML = `
                ${id > 0 ? `<button class="remove-btn" onclick="this.closest('.horario-block').remove(); delete horariosCriterios[${id}]; actualizarPreview();">‚úï</button>` : ""}
                <div class="three-col">
                    <div><label class="std-title">Fechas</label><input type="date" class="horario-fecha" data-id="${id}" value="${dataPrevia?.fecha || ''}"/></div>
                    <div><label class="std-title">Inicio</label><input type="time" class="horario-inicio" data-id="${id}" value="${dataPrevia?.inicio || ''}"/></div>
                    <div><label class="std-title">Fin</label><input type="time" class="horario-fin" data-id="${id}" value="${dataPrevia?.fin || ''}"/></div>
                </div>
                <label class="std-title">Descripci√≥n</label><input type="text" class="horario-desc" data-id="${id}" value="${escapeHtml(dataPrevia?.descripcion || '')}" />
                
                <div class="two-col" style="margin-top:12px">
                    <button class="btn ghost" onclick="abrirModalAuditores(${id})">Auditores</button>
                    <button class="btn ghost" onclick="abrirModalAuditados(${id})">Auditados</button>
                </div>
                <div id="personas-visual-${id}" style="margin-top:8px;font-size:13px;color:#555"></div>

                <div style="margin-top:12px">
                    <h4 class="std-title">Criterios</h4>
                    <div class="two-col">
                        <button class="btn ghost" onclick="abrirModalProcesos(${id})">Procesos</button>
                        <button class="btn ghost" onclick="abrirModalNormas(${id})">Requisitos</button>
                    </div>
                    <div id="criterios-visual-${id}" class="criterios-seleccionados" style="display:none"></div>
                </div>`;
            
            container.appendChild(div);
            div.querySelectorAll("input").forEach(el => el.addEventListener("input", actualizarPreview));

            horariosCriterios[id] = dataPrevia ? {
                procesos: dataPrevia.procesos || [],
                normas: dataPrevia.normas || [],
                auditores: dataPrevia.auditores.map(a => a.nombre || a),
                auditados: dataPrevia.auditados.map(a => a.nombre || a),
                correosAuditores: dataPrevia.auditores.map(a => a.correo || ""),
                correosAuditados: dataPrevia.auditados.map(a => a.correo || "")
            } : {
                procesos: [],
                normas: [],
                auditores: [],
                auditados: [],
                correosAuditores: [],
                correosAuditados: []
            };

            actualizarVisualFormulario(id);
        }

        function actualizarVisualFormulario(id) {
            const data = horariosCriterios[id];
            const divPersonas = document.getElementById(`personas-visual-${id}`);
            const divCriterios = document.getElementById(`criterios-visual-${id}`);

            let htmlP = "";
            if (data.auditores.length) htmlP += `<div style="margin-bottom:4px"><strong>Auditores:</strong> ${data.auditores.join(", ")}</div>`;
            if (data.auditados.length) htmlP += `<div><strong>Auditados:</strong> ${data.auditados.join(", ")}</div>`;
            divPersonas.innerHTML = htmlP;

            let htmlC = "";
            if (data.procesos.length) {
                htmlC += `<div><strong>üß© Procesos:</strong> <span class="persona-preview-add" onclick="abrirModalProcesos(${id})">+</span></div>`;
                data.procesos.forEach(p => {
                    htmlC += `<div style="margin-top:4px"><strong>${escapeHtml(p.proceso)}:</strong></div>`;
                    p.subprocesos.forEach(sub => {
                        htmlC += `<div style="margin-left:10px;font-size:12px">‚Ä¢ ${escapeHtml(sub)} <span class="criterio-remove" onclick="removerSubCriterio(${id}, 'procesos', '${escapeHtml(p.proceso)}', '${escapeHtml(sub)}')">x</span></div>`;
                    });
                });
            }
            if (data.normas.length) {
                htmlC += `<div style="margin-top:8px"><strong>üìã Normas:</strong> <span class="persona-preview-add" onclick="abrirModalNormas(${id})">+</span></div>`;
                data.normas.forEach(n => {
                    htmlC += `<div style="margin-top:4px"><strong>${escapeHtml(n.norma)}:</strong></div>`;
                    n.requisitos.forEach(req => {
                        htmlC += `<div style="margin-left:10px;font-size:12px">‚Ä¢ ${escapeHtml(req)} <span class="criterio-remove" onclick="removerSubCriterio(${id}, 'normas', '${escapeHtml(n.norma)}', '${escapeHtml(req)}')">x</span></div>`;
                    });
                });
            }
            divCriterios.innerHTML = htmlC;
            divCriterios.style.display = htmlC ? "block" : "none";
        }

        function removerSubCriterio(id, tipo, padre, item) {
            const data = horariosCriterios[id];
            const listaPrincipal = tipo === "procesos" ? data.procesos : data.normas;
            const key = tipo === "procesos" ? "proceso" : "norma";
            const subKey = tipo === "procesos" ? "subprocesos" : "requisitos";

            const obj = listaPrincipal.find(x => x[key] === padre);
            if (obj) {
                const idx = obj[subKey].indexOf(item);
                if (idx > -1) {
                    obj[subKey].splice(idx, 1);
                    if (obj[subKey].length === 0) {
                        const idxPadre = listaPrincipal.indexOf(obj);
                        listaPrincipal.splice(idxPadre, 1);
                    }
                    actualizarVisualFormulario(id);
                    actualizarPreview();
                }
            }
        }

        /* MODALES PERSONAS */
        function abrirModalAuditores(id) {
            modalHorarioActual = id;
            modalPersonasTipo = "auditores";
            personasSeleccionadas = horariosCriterios[id].auditores || [];
            mostrarModalPersonas("Auditores", auditores);
        }

        function abrirModalAuditados(id) {
            modalHorarioActual = id;
            modalPersonasTipo = "auditados";
            personasSeleccionadas = horariosCriterios[id].auditados || [];
            mostrarModalPersonas("Auditados", auditados);
        }

        function mostrarModalPersonas(titulo, lista) {
            document.getElementById("modalPersonasTitle").textContent = titulo;
            const body = document.getElementById("modalPersonasBody");
            body.innerHTML = "";
            document.getElementById("buscarPersona").value = "";
            lista.forEach(p => {
                const div = document.createElement("div");
                div.className = "checklist-item";
                const checked = personasSeleccionadas.includes(p.nombre) ? "checked" : "";
                div.innerHTML = `<label><input type="checkbox" value="${escapeHtml(p.nombre)}" data-correo="${escapeHtml(p.correo)}" ${checked}> <span class="persona-nombre">${escapeHtml(p.nombre)}</span> ‚Ä¢ <span style="font-size:12px;color:#666">${escapeHtml(p.correo)}</span></label>`;
                body.appendChild(div);
            });
            document.getElementById("modalPersonas").classList.add("active");
        }

        function filtrarPersonas() {
            const term = document.getElementById("buscarPersona").value.toLowerCase();
            document.querySelectorAll("#modalPersonasBody .checklist-item").forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(term) ? "" : "none";
            });
        }

        function cerrarModalPersonas() { document.getElementById("modalPersonas").classList.remove("active"); }

        function guardarPersonasSeleccionadas() {
            const checks = document.querySelectorAll('#modalPersonasBody input:checked');
            const data = horariosCriterios[modalHorarioActual];
            if (modalPersonasTipo === "auditores") {
                data.auditores = Array.from(checks).map(c => c.value);
                data.correosAuditores = Array.from(checks).map(c => c.dataset.correo);
            } else {
                data.auditados = Array.from(checks).map(c => c.value);
                data.correosAuditados = Array.from(checks).map(c => c.dataset.correo);
            }
            actualizarVisualFormulario(modalHorarioActual);
            actualizarPreview();
            cerrarModalPersonas();
        }

        /* MODALES CRITERIOS */
        function abrirModalProcesos(id) {
            modalHorarioActual = id;
            modalTipoActual = "procesos";
            document.getElementById("modalTitle").textContent = "Seleccionar Procesos";
            mostrarLista(Object.keys(procesos), "procesos");
        }

        function abrirModalNormas(id) {
            modalHorarioActual = id;
            modalTipoActual = "normas";
            document.getElementById("modalTitle").textContent = "Seleccionar Requisitos";
            mostrarLista(Object.keys(normas), "normas");
        }

        function mostrarLista(items, tipo) {
            const body = document.getElementById("modalBody");
            body.innerHTML = "";
            items.sort().forEach(it => {
                const btn = document.createElement("button");
                btn.className = "modal-vertical-btn";
                btn.textContent = it;
                btn.onclick = () => {
                    if (tipo === "procesos") mostrarSub(it, procesos[it], "procesos");
                    else mostrarSub(it, normas[it], "normas");
                };
                body.appendChild(btn);
            });
            document.getElementById("modalCriterios").classList.add("active");
        }

        function mostrarSub(padre, hijos, tipo) {
            const body = document.getElementById("modalBody");
            body.innerHTML = `<h4 style="color:var(--tinto-titulos);font-family:var(--font-main)">${padre}</h4>`;
            hijos.forEach(h => {
                const div = document.createElement("div");
                div.className = "checklist-item";
                div.innerHTML = `<label><input type="checkbox" value="${escapeHtml(h)}"> ${escapeHtml(h)}</label>`;
                body.appendChild(div);
            });
            const back = document.createElement("button");
            back.className = "modal-vertical-btn";
            back.textContent = "‚¨Ö Volver";
            back.style.marginTop = "10px";
            back.onclick = () => mostrarLista(Object.keys(tipo === "procesos" ? procesos : normas), tipo);
            body.appendChild(back);
            if (tipo === "procesos") modalProcesoSeleccionado = padre;
            else modalNormaSeleccionada = padre;
        }

        function guardarCriterios() {
            const sel = Array.from(document.querySelectorAll('#modalBody input:checked')).map(c => c.value);
            const d = horariosCriterios[modalHorarioActual];
            if (modalTipoActual === "procesos") {
                const ex = d.procesos.find(p => p.proceso === modalProcesoSeleccionado);
                if (ex) ex.subprocesos = sel;
                else d.procesos.push({ proceso: modalProcesoSeleccionado, subprocesos: sel });
            } else {
                const ex = d.normas.find(n => n.norma === modalNormaSeleccionada);
                if (ex) ex.requisitos = sel;
                else d.normas.push({ norma: modalNormaSeleccionada, requisitos: sel });
            }
            actualizarVisualFormulario(modalHorarioActual);
            actualizarPreview();
            cerrarModal();
        }

        function cerrarModal() { document.getElementById("modalCriterios").classList.remove("active"); }

        /* PREVIEW */
        function actualizarPreview() {
            let isPlanear = !document.getElementById("vistaPlanear").classList.contains("hidden");
            const nombre = isPlanear ? document.getElementById("nombreAuditoria").value : document.getElementById("edit_nombre").value;
            const scope = isPlanear ? document.getElementById("alcanceInput").value : document.getElementById("edit_alcance").value;
            const mod = isPlanear ? document.getElementById("modalidadSelect").value : document.getElementById("edit_modalidad").value;
            const tipo = isPlanear ? document.getElementById("tipoSelect").value : document.getElementById("edit_tipo").value;

            if (isPlanear) {
                document.getElementById("pv_nombre").textContent = nombre || "‚Äî";
                document.getElementById("pv_alcance").textContent = scope || "‚Äî";
                document.getElementById("pv_modalidad").textContent = mod || "‚Äî";
                document.getElementById("pv_tipo").textContent = tipo || "‚Äî";
                const objs = Array.from(document.querySelectorAll("#objetivosContainer input:checked")).map(c => c.value);
                document.getElementById("pv_objetivos").textContent = objs.join(", ") || "‚Äî";
                generarHtmlHorariosPreview("horariosContainer", "pv_horarios");
            }
        }

        function generarHtmlHorariosPreview(sourceId, targetId) {
            const container = document.getElementById(targetId);
            const bloques = document.getElementById(sourceId).querySelectorAll(".horario-block");
            let html = "";
            bloques.forEach(b => {
                const id = b.dataset.id;
                const data = horariosCriterios[id];
                const fecha = b.querySelector(".horario-fecha").value;
                if (!fecha) return;

                html += `<div class="preview-day"><strong style="color:var(--rojo)">${fecha} (${b.querySelector(".horario-inicio").value} - ${b.querySelector(".horario-fin").value})</strong>`;
                html += `<div style="margin-top:5px;font-size:13px">`;
                
                if (data.auditores.length) {
                    html += `<strong>Auditores:</strong> `;
                    data.auditores.forEach(n => html += `<span class="persona-preview-item">${n} <span class="persona-preview-remove" onclick="removerPersona(${id},'auditores','${n}')">x</span></span>`);
                    html += `<span class="persona-preview-add" onclick="abrirModalAuditores(${id})">+</span><br>`;
                } else html += `Auditores: <span class="persona-preview-add" onclick="abrirModalAuditores(${id})">+</span><br>`;

                if (data.auditados.length) {
                    html += `<strong>Auditados:</strong> `;
                    data.auditados.forEach(n => html += `<span class="persona-preview-item">${n} <span class="persona-preview-remove" onclick="removerPersona(${id},'auditados','${n}')">x</span></span>`);
                    html += `<span class="persona-preview-add" onclick="abrirModalAuditados(${id})">+</span>`;
                } else html += `Auditados: <span class="persona-preview-add" onclick="abrirModalAuditados(${id})">+</span>`;
                
                html += `</div>`;

                if (data.procesos.length) {
                    html += `<div style="margin-top:8px;font-size:13px"><strong>üß© Procesos seleccionados:</strong>`;
                    data.procesos.forEach(p => {
                        html += `<div style="font-weight:bold;margin-top:4px">${p.proceso}:</div><div class="criterio-detail-list">`;
                        p.subprocesos.forEach(sub => html += `<div>‚Ä¢ ${sub}</div>`);
                        html += `</div>`;
                    });
                    html += `</div>`;
                }
                if (data.normas.length) {
                    html += `<div style="margin-top:8px;font-size:13px"><strong>üìã Normas seleccionadas:</strong>`;
                    data.normas.forEach(n => {
                        html += `<div style="font-weight:bold;margin-top:4px">${n.norma}:</div><div class="criterio-detail-list">`;
                        n.requisitos.forEach(req => html += `<div>‚Ä¢ ${req}</div>`);
                        html += `</div>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            });
            container.innerHTML = html || "‚Äî";
        }

        function removerPersona(id, tipo, nombre) {
            const data = horariosCriterios[id];
            const idx = data[tipo].indexOf(nombre);
            if (idx > -1) {
                data[tipo].splice(idx, 1);
                const keyC = tipo === "auditores" ? "correosAuditores" : "correosAuditados";
                if (data[keyC]) data[keyC].splice(idx, 1);
                actualizarVisualFormulario(id);
                actualizarPreview();
            }
        }

        /* EDITAR */
        function abrirPanelEditar() {
            document.getElementById("panelEditar").classList.add("active");
            document.getElementById("overlayEditar").classList.add("active");
            document.getElementById("selectorIDs").classList.remove("hidden");
            document.getElementById("formularioEdicion").classList.add("hidden");
            google.script.run.withSuccessHandler(ids => {
                const g = document.getElementById("idsGrid");
                g.innerHTML = "";
                ids.forEach(id => {
                    const b = document.createElement("div");
                    b.className = "id-btn";
                    b.textContent = id;
                    b.onclick = () => cargarEdicion(id);
                    g.appendChild(b);
                });
            }).obtenerIDsAuditorias();
        }

        function cerrarPanelEditar() {
            document.getElementById("panelEditar").classList.remove("active");
            document.getElementById("overlayEditar").classList.remove("active");
        }

        function filtrarIDs() {
            const term = document.getElementById("buscarID").value.toLowerCase();
            document.querySelectorAll(".id-btn").forEach(b => b.style.display = b.innerText.toLowerCase().includes(term) ? "" : "none");
        }

        function cargarEdicion(id) {
            flashMessage("Cargando...", 0);
            google.script.run.withSuccessHandler(aud => {
                if (!aud) {
                    flashMessage("Error", 2000);
                    return;
                }
                auditoriaEnEdicion = aud;
                document.getElementById("selectorIDs").classList.add("hidden");
                document.getElementById("formularioEdicion").classList.remove("hidden");
                renderFormularioEdicion(aud);
                flashMessage("Cargado", 1000);
            }).obtenerAuditoriaPorID(id);
        }

        function renderFormularioEdicion(aud) {
            const f = document.getElementById("formularioEdicion");
            f.innerHTML = `
                <div style="margin-bottom:20px; display:flex; justify-content:space-between;">
                   <h3 class="std-title" style="margin:0; font-size:18px;">Editando: ${aud.id}</h3>
                   <button class="btn ghost" onclick="abrirPanelEditar()">Volver</button>
                </div>
                <label class="std-title">Nombre de la auditor√≠a</label><input type="text" id="edit_nombre" value="${escapeHtml(aud.nombre)}">
                <label class="std-title">Objetivos</label><div class="objetivos-grid" id="edit_objetivos"></div>
                <label class="std-title">Alcance</label><textarea id="edit_alcance">${escapeHtml(aud.alcance)}</textarea>
                <label class="std-title">Riesgos</label><div class="risk-text">Ver documento "Programa de auditor√≠as"</div>
                <div class="two-col">
                   <div><label class="std-title">Modalidad</label><select id="edit_modalidad"><option>Presencial</option><option>Virtual</option><option>Mixta</option></select></div>
                   <div><label class="std-title">Tipo de auditor√≠a</label><select id="edit_tipo"><option>Interna</option><option>Externa</option></select></div>
                </div>
                <h4 class="std-title" style="margin-top:20px; border-bottom:1px solid #eee;">Horarios (Auditores, Auditados, Criterios)</h4>
                <div id="horariosEdicionContainer"></div>
                <button class="btn add-btn" onclick="agregarHorario(null, 'horariosEdicionContainer')">+ Agregar horario</button>
                <label class="std-title">Observaciones</label><textarea id="edit_obs">${escapeHtml(aud.observaciones)}</textarea>
                <div style="margin-top:20px; display:flex; gap:10px;"><button class="btn" onclick="guardarCambiosEdicion()">Guardar Cambios</button><button class="btn secondary" onclick="cerrarPanelEditar()">Cancelar</button></div>
            `;
            document.getElementById("edit_modalidad").value = aud.modalidad;
            document.getElementById("edit_tipo").value = aud.tipo;

            const objCont = document.getElementById("edit_objetivos");
            objetivosList.forEach(obj => {
                const div = document.createElement("div");
                div.className = "objetivo-item";
                const chk = aud.objetivos.includes(obj) ? "checked" : "";
                div.innerHTML = `<label><input type="checkbox" value="${escapeHtml(obj)}" ${chk}> ${escapeHtml(obj)}</label>`;
                objCont.appendChild(div);
            });

            document.getElementById("horariosEdicionContainer").innerHTML = "";
            aud.horarios.forEach(h => agregarHorario(h, "horariosEdicionContainer"));
        }

        function guardarCambiosEdicion() {
            const hData = [];
            document.getElementById("horariosEdicionContainer").querySelectorAll(".horario-block").forEach(b => {
                const id = b.dataset.id;
                hData.push({
                    fecha: b.querySelector(".horario-fecha").value,
                    inicio: b.querySelector(".horario-inicio").value,
                    fin: b.querySelector(".horario-fin").value,
                    descripcion: b.querySelector(".horario-desc").value,
                    ...horariosCriterios[id]
                });
            });
            const payload = {
                id: auditoriaEnEdicion.id,
                nombre: document.getElementById("edit_nombre").value,
                objetivos: Array.from(document.getElementById("edit_objetivos").querySelectorAll("input:checked")).map(c => c.value),
                alcance: document.getElementById("edit_alcance").value,
                modalidad: document.getElementById("edit_modalidad").value,
                tipo: document.getElementById("edit_tipo").value,
                observaciones: document.getElementById("edit_obs").value,
                horarios: hData
            };
            flashMessage("Guardando cambios...", 0);
            google.script.run.withSuccessHandler(res => {
                if (res.success) {
                    flashMessage("‚úÖ Actualizado", 3000);
                    cerrarPanelEditar();
                } else flashMessage("‚ùå " + res.error, 5000);
            }).editarAuditoria(payload);
        }

        function accionGuardarYCrear() {
            const hData = [];
            document.getElementById("horariosContainer").querySelectorAll(".horario-block").forEach(b => {
                const id = b.dataset.id;
                hData.push({
                    fecha: b.querySelector(".horario-fecha").value,
                    inicio: b.querySelector(".horario-inicio").value,
                    fin: b.querySelector(".horario-fin").value,
                    descripcion: b.querySelector(".horario-desc").value,
                    ...horariosCriterios[id]
                });
            });
            const payload = {
                nombre: document.getElementById("nombreAuditoria").value,
                objetivos: Array.from(document.querySelectorAll("#objetivosContainer input:checked")).map(c => c.value),
                alcance: document.getElementById("alcanceInput").value,
                modalidad: document.getElementById("modalidadSelect").value,
                tipo: document.getElementById("tipoSelect").value,
                observaciones: document.getElementById("obsInput").value,
                horarios: hData
            };
            if (!payload.nombre || !payload.horarios.length) {
                alert("Faltan datos");
                return;
            }
            flashMessage("Guardando...", 0);
            google.script.run.withSuccessHandler(res => {
                if (res.success) {
                    flashMessage("‚úÖ Creado: " + res.id, 3000);
                    limpiarFormulario();
                    google.script.run.withSuccessHandler(d => {
                        registroCalendario = d || [];
                        renderCalendario();
                    }).obtenerAuditoriasCalendario();
                } else flashMessage("‚ùå " + res.error, 5000);
            }).crearAuditoria(payload);
        }

        function limpiarFormulario() {
            document.getElementById("nombreAuditoria").value = "";
            document.getElementById("horariosContainer").innerHTML = "";
            agregarHorario();
            actualizarPreview();
        }

        function renderCalendario() {
            const mesLabel = document.getElementById("mesActual");
            const grid = document.getElementById("calendarioGrid");
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const year = fechaCalendario.getFullYear();
            const month = fechaCalendario.getMonth();
            mesLabel.textContent = `${meses[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            grid.innerHTML = "";
            ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"].forEach(d => grid.innerHTML += `<div style="text-align:center;font-weight:700;padding:8px">${d}</div>`);
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement("div"));
            for (let d = 1; d <= daysInMonth; d++) {
                const fStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
                const audits = registroCalendario.filter(r => r.fecha === fStr);
                const div = document.createElement("div");
                div.className = "calendar-day" + (audits.length ? " has-audit" : "");
                let tool = "";
                if (audits.length) {
                    tool = `<div class="calendar-tooltip"><strong>${d} de ${meses[month]}</strong>`;
                    audits.forEach(a => tool += `<div style="margin-top:5px;font-size:12px;border-top:1px solid #ffffff40;padding-top:4px">${a.id}: ${a.nombre}<br>${a.inicio}-${a.fin}</div>`);
                    tool += "</div>";
                }
                div.innerHTML = `<div class="day-number">${d}</div>${audits.length ? `<div class="badge">${audits.length}</div>` : ""}${tool}`;
                grid.appendChild(div);
            }
        }

        function cambiarMes(d) {
            fechaCalendario.setMonth(fechaCalendario.getMonth() + d);
            renderCalendario();
        }

        function escapeHtml(t) {
            return t ? String(t).replace(/[&<>"']/g, m => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#039;"
            }[m])) : "";
        }

        function flashMessage(m, d) {
            const a = document.getElementById("msgArea");
            a.innerHTML = `<div class="card" style="background:${d === 0 ? '#fff3cd' : '#f0fff4'}">${m}</div>`;
            if (d > 0) setTimeout(() => a.innerHTML = "", d);
        }
    </script>
</body>
</html>
